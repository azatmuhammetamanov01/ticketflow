-include .env
export $(shell sed 's/=.*//' .env)

APP_NAME := event-service
CMD_DIR := cmd/event-service
PROTO_DIR := proto
GOOGLEAPIS_DIR := googleapis
MIGRATIONS_DIR := migrations

DB_URL := postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSLMODE}

proto:
	protoc -I $(PROTO_DIR) -I $(GOOGLEAPIS_DIR) \
		--go_out=$(PROTO_DIR) --go_opt=paths=source_relative \
		--go-grpc_out=$(PROTO_DIR) --go-grpc_opt=paths=source_relative \
		--grpc-gateway_out=$(PROTO_DIR) --grpc-gateway_opt=paths=source_relative \
		--openapiv2_out=$(PROTO_DIR) \
		$(PROTO_DIR)/*.proto

build:
	go build -o bin/$(APP_NAME) ./$(CMD_DIR)

run:
	go run ./$(CMD_DIR)

migrate-up:
	goose -dir $(MIGRATIONS_DIR) postgres "$(DB_URL)" up

docker-build:
	docker build -t $(APP_NAME) .

up:
	docker compose up --build -d

down:
	docker compose down

logs:
	docker compose logs -f
