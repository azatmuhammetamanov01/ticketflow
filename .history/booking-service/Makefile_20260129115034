-include .env
export $(shell sed 's/=.//' .env	)

APP_NAME := booking-service
CMD_DIR := cmd/booking-service
PROTO_DIR := proto
GOOGLEAPIS_DIR := googleapis
MIGRATIONS_DIR := migrations

DB_URL := postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSLMODE}
.PHONY: help
help:
	@echo "Available targets:"
	@echo "  make proto            Generate gRPC & Gateway code"
	@echo "  make build            Build Go binary"
	@echo "  make run              Run service locally"
	@echo "  make migrate-create   Create new migration (name=xxx)"
	@echo "  make docker-build     Build Docker image"
	@echo "  make up               Docker compose up"

.PHONY: migration-create

migration-create:
	@mkdir -p $(MIGRATION_DIR)
	@goose -dir $(MIGRATION_DIR) create $(name) sql

.PHONY: build
build:
	go build -o booking-service ./server/main.go

.PHONY: proto
proto:
	protoc -I proto -I googleapis \
  		--go_out=proto --go_opt=paths=source_relative \
  		--go-grpc_out=proto --go-grpc_opt=paths=source_relative \
  		--grpc-gateway_out=proto --grpc-gateway_opt=paths=source_relative \
  		proto/booking.proto
	

.PHONY: docker-build
docker-build:
	docker build -t booking-service .

.PHONY: docker-run
docker-run:
	docker run --network=host \
	-e DB_HOST=localhost \
    -e DB_PORT=${DB_PORT} \
    -e DB_USER=${DB_USER} \
    -e DB_PASSWORD=${DB_PASSWORD} \
    -e DB_NAME=${DB_NAME} \
    -e DB_SSLMODE=${DB_SSLMODE} \
	booking-service

.PHONY: docker build

.PHONY: up
up:
	docker compose up --build -d